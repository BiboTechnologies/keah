import{initializeApp}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js";import{getStorage,ref as storageRef,uploadBytes,getDownloadURL}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-storage.js";import{getDatabase,ref,remove,push,get,update,onValue,child,set}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-database.js";import{getAuth,onAuthStateChanged,sendPasswordResetEmail,signInWithEmailAndPassword,GoogleAuthProvider,signInWithPopup}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-auth.js";const firebaseConfig={apiKey:"AIzaSyCi_hufIZTzsYtdPGQtvtmKmAkkrydmn_A",authDomain:"abbah-83a7b.firebaseapp.com",databaseURL:"https://abbah-83a7b-default-rtdb.firebaseio.com",projectId:"abbah-83a7b",storageBucket:"abbah-83a7b.appspot.com",messagingSenderId:"379729759051",appId:"1:379729759051:web:e75528d61b02d1e4f536ce",measurementId:"G-H41J2WMR6S"};const app=initializeApp(firebaseConfig);const database=getDatabase(app);const auth=getAuth(app);const storage=getStorage(app);let authToken;let tokenExpiryTime;function generateToken(){authToken=Math.random().toString(36).substring(2);const currentTime=new Date;const tokenExpiryTime=new Date(currentTime.getTime()+24*60*60*1e3);localStorage.setItem("authToken",authToken);localStorage.setItem("tokenExpiryTime",tokenExpiryTime.toString())}function retrieveTokenFromLocalStorage(){authToken=localStorage.getItem("authToken");const storedExpiryTime=localStorage.getItem("tokenExpiryTime");if(authToken&&storedExpiryTime){tokenExpiryTime=new Date(storedExpiryTime)}}function isTokenValid(){const currentTime=new Date;return tokenExpiryTime>currentTime}window.addEventListener("load",function(){retrieveTokenFromLocalStorage();if(!isTokenValid()){window.location.href="login.html"}});document.addEventListener("contextmenu",function(event){if(document.getElementById("loginpopup").style.display==="block"){event.preventDefault()}document.addEventListener("keydown",function(event){if(event.keyCode===123){event.preventDefault()}})});const allowedEmails=["biboofficial256@gmail.com"];document.getElementById("loginForm").addEventListener("submit",function(event){event.preventDefault();const submitBtn=document.getElementById("submitBtn");submitBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Submitting';const email=document.getElementById("email").value;const password=document.getElementById("password").value;signInWithEmailAndPassword(auth,email,password).then(userCredential=>{if(allowedEmails.includes(email)){document.getElementById("loginoverlay").style.display="none";document.getElementById("loginpopup").style.display="none";generateToken()}else{const errorContainer=document.getElementById("errorContainer");errorContainer.textContent="Access denied. You are not authorized.";errorContainer.style.display="block";signOut(auth).then(()=>{setTimeout(function(){submitBtn.innerHTML="Submit"},2e3)}).catch(error=>{console.error("Error signing out:",error)})}}).catch(error=>{const errorMessage=error.message;const errorContainer=document.getElementById("errorContainer");errorContainer.textContent=errorMessage;errorContainer.style.display="block";setTimeout(function(){submitBtn.innerHTML="Submit"},2e3)})});document.getElementById("forgotPasswordLink").addEventListener("click",function(event){event.preventDefault();const email=document.getElementById("email").value;sendPasswordResetEmail(auth,email).then(()=>{showMessage(" A password reset email has been sent. Please check your inbox.")}).catch(error=>{const errorMessage=error.message;alert("Password reset email failed to send. "+errorMessage)})});function displayMessage(title,message,isSuccess=false){const existingMessages=document.querySelectorAll(".retry-message");existingMessages.forEach(function(message){message.remove()});const messageDiv=document.createElement("div");messageDiv.classList.add("retry-message");if(isSuccess){messageDiv.style.backgroundColor="#4caf50"}const closeButton=document.createElement("button");closeButton.classList.add("close-btn");closeButton.innerHTML='<i class="fa fa-times"></i>';closeButton.addEventListener("click",function(){messageDiv.remove()});const titleElement=document.createElement("h2");titleElement.textContent=title;const messageElement=document.createElement("p");messageElement.textContent=message;messageDiv.appendChild(titleElement);messageDiv.appendChild(messageElement);document.body.appendChild(messageDiv);setTimeout(function(){messageDiv.remove()},1500)}function displayUserInformation(user){const profileName=document.querySelector(".profile_info h2");profileName.textContent=user.displayName;const profileImage=document.querySelector(".profile_pic img");profileImage.src=user.photoURL;const dropdownProfileImage=document.querySelector(".user-profile img");dropdownProfileImage.src=user.photoURL;displayMessage("",`Welcome, ${user.displayName}.`,true)}function handleSignInSuccess(user){displayUserInformation(user)}function handleSignInError(error){console.error("Error signing in:",error);displayMessage("Access Denied. Please sign in with a valid email.")}function signInWithGoogle(){var provider=new GoogleAuthProvider;signInWithPopup(auth,provider).then(function(result){const user=result.user;handleSignInSuccess(user)}).catch(function(error){handleSignInError(error)})}window.addEventListener("load",function(){auth.onAuthStateChanged(function(user){if(user){displayUserInformation(user)}else{signInWithGoogle()}})});function retryCallback(){signInWithGoogle()}displayMessage("Signing in...","Please wait...",false);document.addEventListener("click",function(event){const target=event.target;if(target.tagName==="A"&&target.href.startsWith(window.location.origin)){localStorage.setItem("clickedLink",target.href)}});const logoutButton=document.getElementById("logoutButton");const overlay=document.getElementById("overlay");logoutButton.addEventListener("click",function(event){event.preventDefault();localStorage.setItem("logoutPage",window.location.href);const clickedLink=localStorage.getItem("clickedLink");if(clickedLink){localStorage.setItem("logoutPage",clickedLink)}displayOverlay();setTimeout(()=>{logOut();hideOverlay()},2e3)});function displayOverlay(){const spinner=document.createElement("div");spinner.id="loadingSpinner";overlay.appendChild(spinner);const loggingOutText=document.createElement("div");loggingOutText.id="loggingOutText";loggingOutText.textContent="Logging Out...";overlay.appendChild(loggingOutText);overlay.style.display="flex"}function hideOverlay(){const spinner=document.getElementById("loadingSpinner");const loggingOutText=document.getElementById("loggingOutText");overlay.removeChild(spinner);overlay.removeChild(loggingOutText);overlay.style.display="none"}function logOut(){auth.signOut().then(function(){localStorage.removeItem("authToken");localStorage.removeItem("tokenExpiryTime");localStorage.removeItem("clickedLink");const logoutPage=localStorage.getItem("logoutPage")||"login.html";window.location.href=logoutPage}).catch(function(error){console.error("Error signing out:",error)})}const form=document.querySelector(".popup-form");const submitButton=document.querySelector(".popup-form button");const patientsContainer=document.getElementById("patients");const loader=document.getElementById("loader");let patients=[];let patientCount=1;const patientsRef=ref(database,"patients");get(patientsRef).then(snapshot=>{if(snapshot.exists()){const patientData=snapshot.val();const patientIds=Object.values(patientData).map(patient=>parseInt(patient.patientId));patientCount=Math.max(...patientIds,0)+1}else{patientCount=1}form.addEventListener("submit",function(e){e.preventDefault();const name=document.getElementById("name").value.trim();const dob=document.getElementById("dob").value;const parents=document.getElementById("parents").value;const residence=document.getElementById("residence").value;const payment=document.getElementById("payment").value;const sex=document.getElementById("sex").value;const patientId=patientCount.toString();const patientData={name:name,dob:dob,parents:parents,residence:residence,payment:payment,sex:sex,patientId:patientId};const newPatientRef=ref(database,`patients/${name}`);get(newPatientRef).then(snapshot=>{if(snapshot.exists()){alert("Patient with the same name already exists.")}else{loader.style.display="block";set(newPatientRef,patientData).then(()=>{form.reset();showMessage("Patient details uploaded successfully!");patientCount++;loader.style.display="none"}).catch(error=>{console.error("Error uploading patient details:",error);showMessage("Error uploading patient details. Please try again.");loader.style.display="none"})}}).catch(error=>{console.error("Error checking if patient exists:",error);showMessage("Error checking if patient exists. Please try again.");loader.style.display="none"})})}).catch(error=>{console.error("Error retrieving patient count:",error);showMessage("Error retrieving patient count. Please try again.")});searchButton.addEventListener("click",()=>{const searchTerm=searchInput.value.trim();loaderElement.classList.remove("hidden");patientsContainer.innerHTML="";const patientsRef=ref(database,"patients");onValue(patientsRef,snapshot=>{const patientsData=snapshot.val();const searchResults=[];if(patientsData){const patients=Object.entries(patientsData);if(searchTerm!==""){patients.forEach(([patientId,patient])=>{if(patient.name.toLowerCase().includes(searchTerm.toLowerCase())||patient.patientId.includes(searchTerm)){searchResults.push(patient)}})}else{searchResults.push(...patients.map(([patientId,patient])=>patient))}}loaderElement.classList.add("hidden");if(searchResults.length>0){renderPatients(searchResults)}else{patientsContainer.innerHTML='<p class="no-results">No Patients found.</p>'}})});function filterPatients(patients,searchTerm){const filteredPatients=patients.filter(patient=>{const patientName=patient.name.toLowerCase();return patientName.includes(searchTerm.toLowerCase())});renderPatients(filteredPatients)}let patientsData=[];let searchResults=[];let currentPage=1;const patientsPerPage=10;searchInput.addEventListener("input",()=>{const searchTerm=searchInput.value.trim().toLowerCase();searchResults=[];if(searchTerm!==""){searchResults=patientsData.filter(patient=>{return patient.name.toLowerCase().includes(searchTerm)||patient.patientId.includes(searchTerm)})}currentPage=1;renderPatients()});onValue(patientsRef,snapshot=>{patientsData=snapshot.val()?Object.values(snapshot.val()):[];renderPatients()});function renderPatients(){patientsContainer.innerHTML="";const dataToDisplay=searchResults.length>0?searchResults:patientsData;const startIndex=(currentPage-1)*patientsPerPage;const endIndex=startIndex+patientsPerPage;const patientsForPage=dataToDisplay.slice(startIndex,endIndex);const table=document.createElement("table");table.classList.add("patient-table");const tableHeaderRow=document.createElement("tr");tableHeaderRow.classList.add("table-header");const headers=["Name","Place of Residence","Payment Terms","Sex","Patient ID","Contact","Date of Birth","Age","Actions"];headers.forEach(headerText=>{const tableHeaderCell=document.createElement("th");tableHeaderCell.textContent=headerText;tableHeaderRow.appendChild(tableHeaderCell)});function createHiddenDigitsTableCell(text,visibleDigitsCount){const cell=document.createElement("td");const hiddenDigits="*".repeat(text.length-visibleDigitsCount);const visibleDigits=text.slice(-visibleDigitsCount);cell.textContent=hiddenDigits+visibleDigits;return cell}table.appendChild(tableHeaderRow);patientsForPage.forEach(patient=>{const tableRow=document.createElement("tr");tableRow.classList.add("table-row");const nameCell=createTableCell(patient.name);const residenceCell=createTableCell(patient.residence);const paymentCell=createTableCell(patient.payment);const sexCell=createTableCell(patient.sex);const patientIdCell=createTableCell("PI - "+patient.patientId);const parentsCell=createHiddenDigitsTableCell(patient.parents,3);const dobCell=createTableCell(patient.dob);const dob=new Date(patient.dob);const today=new Date;const age=today.getFullYear()-dob.getFullYear();const ageCell=createTableCell(age.toString());const actionsCell=document.createElement("td");const viewButton=document.createElement("button");viewButton.textContent="View";viewButton.classList.add("view-button");viewButton.addEventListener("click",function(){currentPatientName=patient.name;openPatientHistoryPopup(patient)});actionsCell.appendChild(viewButton);tableRow.appendChild(nameCell);tableRow.appendChild(residenceCell);tableRow.appendChild(paymentCell);tableRow.appendChild(sexCell);tableRow.appendChild(patientIdCell);tableRow.appendChild(parentsCell);tableRow.appendChild(dobCell);tableRow.appendChild(ageCell);tableRow.appendChild(actionsCell);table.appendChild(tableRow)});patientsContainer.appendChild(table);const totalPages=Math.ceil(dataToDisplay.length/patientsPerPage);const paginationDiv=document.getElementById("pagination");paginationDiv.innerHTML="";const prevButton=document.createElement("button");prevButton.textContent="Previous";prevButton.addEventListener("click",()=>{if(currentPage>1){currentPage--;renderPatients()}});const nextButton=document.createElement("button");nextButton.textContent="Next";nextButton.addEventListener("click",()=>{if(currentPage<totalPages){currentPage++;renderPatients()}});const pageInfo=document.createElement("span");pageInfo.textContent=`Page ${currentPage} of ${totalPages}`;paginationDiv.appendChild(prevButton);paginationDiv.appendChild(pageInfo);paginationDiv.appendChild(nextButton)}searchInput.addEventListener("input",()=>{const searchTerm=searchInput.value.trim().toLowerCase();searchResults=[];if(searchTerm!==""){searchResults=patientsData.filter(patient=>{return patient.name.toLowerCase().includes(searchTerm)||patient.patientId.includes(searchTerm)})}currentPage=1;renderPatients()});renderPatients();function createTableCell(text){const cell=document.createElement("td");cell.textContent=text;return cell}function openPatientHistoryPopup(patient){const popupOverlay=document.getElementById("popupOverlay1");const popupClose=document.getElementById("popupClose1");const patientDetails=document.getElementById("patientDetails");const patientHistory=document.getElementById("patientHistory");patientDetails.innerHTML="";patientHistory.innerHTML="";popupOverlay.style.visibility="visible";popupOverlay.style.opacity="1";popupClose.addEventListener("click",function(){popupOverlay.style.visibility="hidden";popupOverlay.style.opacity="0"});const patientDetailsHTML=`
  <div class="patient-details">
 
<style>
  .button {
    background-color: #4CAF50;
    border: none;
    color: white;
    padding: 10px;
    text-align: center;
    text-decoration: none;
    font-size: 14px;
    margin: 4px 2px;
    cursor: disabled;
    border-radius: 50px;
  }

  .save-button {
    background-color: #4CAF50;
  }

  .delete-button {
    background-color: #f44336;
  }
</style>
 <div class="patient-image-frame">
  <label for="uploadImage" class="upload-label">
    <i class="fa fa-upload"></i>
    
  </label>
  <input type="file" id="uploadImage" accept="image/*">
</div>
<h3>Patient Demographics:</h3>
<table class="patient-demographics-table">
    <tr>
      <td><strong>Name:</strong></td>
      <td>${patient.name}</td>
    </tr>
    <tr>
      <td><strong>Date of Birth:</strong></td>
      <td>${patient.dob}</td>
    </tr>
    <tr>
      <td><strong>Gender:</strong></td>
      <td>${patient.sex}</td>
    </tr>
    <tr>
      <td><strong>Payment Type:</strong></td>
      <td>${patient.payment}</td>
    </tr>
    <tr>
      <td><strong>Residence:</strong></td>
      <td>${patient.residence}</td>
    </tr>
    <tr>
      <td><strong>Contact:</strong></td>
      <td>${patient.parents}</td>
    </tr>
    <tr>
      <td><strong>Patient ID:</strong></td>
      <td>${patient.patientId}</td>
    </tr>
    <tr>
      <td><strong>Current Patient's Status:</strong></td>
      <td><span id="currentStatus"></span></td>
    </tr>
  </table>
    <div id="barcode"></div> <!-- This is where the generated barcode will be displayed -->

    <!-- Add a "Visit Count" element in your HTML -->
    <p style="text-decoration: underline;"><strong>No. of visits:</strong>  <span id="visitCount"></span></p>
    <!-- Add more patient details as needed -->

    <!-- The container for patient visit details -->
<div id="patientVisitDetails" ></div>
<!-- Add this inside your patient details HTML -->



    <!-- Assuming you have the patient's name as patientName variable -->
<button style="background: darkblue; display:none" id="visit" data-patient="${patient.patientId}" class="button save-button">
  <i id="visitIcon" style="margin-right: 5px;" class="fas fa-calendar-check"></i>Reg. Visit
</button>
          <button  style="background: darkblue; " id="triageButton"  class="button save-button"><i style="margin-right: 5px;" class="fas fa-chart-line"></i>Triage History</button>

<button style="display:none" id="saveButton"  class="button save-button" disabled><i style="margin-right: 5px;" class="fa fa-save"></i>Save Image</button>
<button style="display:none" id="delButton" class="button delete-button"><i class="fa fa-trash"></i>Delete Image</button>
<button style="display:none" id="addToWaitingListButton" class="button save-button">
  <i style="margin-right: 5px;" class="fas fa-list"></i>Add to Waiting List
</button>
<button style="display:none" id="editButton" class="button save-button">
  <i style="margin-right: 5px;" class="fa fa-edit"></i>Edit Details
</button>

  </div>
  `;patientDetails.innerHTML=patientDetailsHTML;const patientHistoryElement=document.getElementById("patientHistory");const uploadImage=document.getElementById("uploadImage");const saveButton=document.getElementById("saveButton");const imageFrame=document.querySelector(".patient-image-frame");if(patient.image){const imageElement=document.createElement("img");imageElement.src=patient.image;imageElement.alt="Patient Image";imageFrame.innerHTML="";imageFrame.appendChild(imageElement)}else{const uploadLabel=document.createElement("p");uploadLabel.htmlFor="uploadImage";uploadLabel.className="no-image-label";uploadLabel.innerHTML=`
  <i class="fas fa-image"></i>
  No Image found
`;const uploadInput=document.createElement("input");uploadInput.type="file";uploadInput.id="uploadImage";uploadInput.accept="image/*";imageFrame.innerHTML="";imageFrame.appendChild(uploadLabel);imageFrame.appendChild(uploadInput);uploadInput.addEventListener("change",function(event){const file=event.target.files[0];const reader=new FileReader;reader.onload=function(e){const imageUrl=e.target.result;const imageElement=document.createElement("img");imageElement.src=imageUrl;imageElement.alt="Patient Image";imageFrame.innerHTML="";imageFrame.appendChild(imageElement);saveButton.disabled=false};reader.readAsDataURL(file)})}saveButton.addEventListener("click",function(){const imageElement=imageFrame.querySelector("img");const imageData=imageElement.src;const patientName=patient.patientId;const filename=`${patientName}_${Date.now()}.jpg`;const imageRef=storageRef(storage,`images/${filename}`);const imageBlob=dataURItoBlob(imageData);const uploadTask=uploadBytes(imageRef,imageBlob);uploadTask.then(function(){getDownloadURL(imageRef).then(function(downloadURL){const patientRef=ref(database,`patients/${patient.name}`);update(patientRef,{image:downloadURL});showMessage("Image saved successfully!")})}).catch(function(error){console.error("Error uploading image:",error);showMessage("Error uploading image. Please try again.")})});const deleteButton=document.getElementById("delButton");deleteButton.addEventListener("click",function(){if(!patient.image){return}const patientRef=ref(database,`patients/${patient.name}`);update(patientRef,{image:null}).then(()=>{imageFrame.innerHTML="";deleteButton.disabled=true;showMessage("Image deleted successfully!")}).catch(error=>{console.error("Error deleting image:",error);showMessage("Error deleting image. Please try again.")})});if(patient.image){const imageElement=document.createElement("img");imageElement.src=patient.image;imageElement.alt="Patient Image";imageFrame.innerHTML="";imageFrame.appendChild(imageElement);deleteButton.disabled=false}function dataURItoBlob(dataURI){const byteString=atob(dataURI.split(",")[1]);const mimeString=dataURI.split(",")[0].split(":")[1].split(";")[0];const ab=new ArrayBuffer(byteString.length);const ia=new Uint8Array(ab);for(let i=0;i<byteString.length;i++){ia[i]=byteString.charCodeAt(i)}return new Blob([ab],{type:mimeString})}const patientName=patient.patientId;const patientHistoryRef=ref(database,`patients/${patientName}/testsTaken`);function getLatestTestStatus(records){if(records.length===0)return"Unknown";records.sort((a,b)=>b.data.dateTaken-a.data.dateTaken);const latestTestStatus=records[0].data.results?.finalStatus||"Pending...";return latestTestStatus}onValue(patientHistoryRef,snapshot=>{patientHistoryElement.innerHTML="";if(snapshot.exists()){const records=[];snapshot.forEach(childSnapshot=>{const recordKey=childSnapshot.key;const record=childSnapshot.val();records.push({key:recordKey,data:record})});const currentStatusElement=document.getElementById("currentStatus");const currentStatus=getLatestTestStatus(records);currentStatusElement.textContent=currentStatus;records.forEach(recordObj=>{const recordKey=recordObj.key;const record=recordObj.data;const recordElement=createRecordElement(recordKey,record);patientHistoryElement.appendChild(recordElement);const testResultRef=ref(database,`patients/${patientName}/testsTaken/${recordKey}/resultsObtained`);onValue(testResultRef,resultSnapshot=>{const resultsObtainedElement=recordElement.querySelector(".results-obtained-data");if(resultsObtainedElement){if(resultSnapshot.exists()){const resultsObtained=resultSnapshot.val();resultsObtainedElement.textContent=resultsObtained==="Completed Successfully"?"Completed Successfully":"Pending...";resultsObtainedElement.style.color=resultsObtained==="Completed Successfully"?"darkblue":"orange"}else{resultsObtainedElement.textContent="Pending...";resultsObtainedElement.style.color="orange"}}else{console.error("results-obtained-data element not found in recordElement")}})})}else{const noRecordsElement=document.createElement("p");noRecordsElement.textContent="No Records Found";noRecordsElement.style.fontStyle="italic";patientHistoryElement.appendChild(noRecordsElement)}});function displayPatientVisitDetails(visitKeys,visitDetails){const patientVisitDetailsDiv=document.getElementById("patientVisitDetails");patientVisitDetailsDiv.innerHTML="";if(visitDetails){const visitKeys=Object.keys(visitDetails);visitKeys.sort((a,b)=>visitDetails[b].timestamp-visitDetails[a].timestamp);const visitCount=visitKeys.length;const visitCountElement=document.getElementById("visitCount");visitCountElement.textContent=visitCount;const latestVisitKey=visitKeys[0];const latestVisitData=visitDetails[latestVisitKey];const visitElement=document.createElement("div");visitElement.innerHTML=`

    <h3>LATEST VISIT TRIAGE:</h3>
<div class="visit-details-container">
  <p><b>Date:</b> ${formatDate(latestVisitData.timestamp)}</p>
  <p><b>Clinician's Name:</b> ${latestVisitData.clinicianName||"N/D"}</p>
  <p><b>Temperature:</b> ${latestVisitData.temperature||"N/D"} &deg;C</p>
  <p><b>BP:</b> ${latestVisitData.bp||"N/D"} (mmHg)</p>
  <p><b>RR:</b> ${latestVisitData.rr||"N/D"}</p>
  <p><b>HR:</b> ${latestVisitData.hr||"N/D"}</p>
  <p><b>SpO2:</b> ${latestVisitData.sp02||"N/D"} (%)</p>
  <p><b>WT:</b> ${latestVisitData.wt||"N/D"} (Kg)</p>
  <p><b>HT:</b> ${latestVisitData.ht||"N/D"} (Cm)</p>
  <p><b>BMI:</b> ${latestVisitData.bmi||"N/D"}</p>
  <p><b>MUAC:</b> ${latestVisitData.muac||"N/D"}</p>
  <p><b>Weight for Age Z score:</b> ${latestVisitData.weightForAgeZScore||"N/D"} (Kg)</p>
  <p><b>Disability:</b> ${latestVisitData.disability||"N/D"}</p>
  <p><b>Known Chronic Illness:</b> ${latestVisitData.chronicIllness||"N/D"}</p>
  <p><b>Any Drug Abuse:</b> ${latestVisitData.drugAbuse||"N/D"}</p>
  <p><b>Allergies:</b> ${latestVisitData.allergies&&latestVisitData.allergies.length>0?latestVisitData.allergies.join(", "):"N/D"}
  </p>
</div>
<hr>


    `;patientVisitDetailsDiv.appendChild(visitElement)}else{patientVisitDetailsDiv.textContent="No visit details found.";patientVisitDetailsDiv.style.fontStyle="italic"}}function getPatientVisitDetails(patientName){const visitsRef=ref(database,`patients/${patientName}/visits`);onValue(visitsRef,snapshot=>{const visitDetails=snapshot.val();if(visitDetails){const visitKeys=Object.keys(visitDetails);visitKeys.sort((a,b)=>visitDetails[b].timestamp-visitDetails[a].timestamp);displayPatientVisitDetails(visitKeys,visitDetails);createVisitTrendChart(visitKeys,visitDetails)}else{displayPatientVisitDetails(null);createVisitTrendChart([],{})}})}getPatientVisitDetails(patientName);let isPopupOpen=false;function closePopup(){visitPopupOverlay.style.display="none"}function formatDate(timestamp){const date=new Date(timestamp);const options={year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"};return date.toLocaleString("en-US",options)}let visitTrendChart;function destroyChart(){if(window.visitTrendChart&&window.visitTrendChart.destroy){window.visitTrendChart.destroy()}}function analyzeAndProvideRecommendations(temperatures,respiratoryRates,heartRates,spO2Values,vitalSignsData){const newTemperature=temperatures[0];const previousTemperature=temperatures[1];const temperatureDifference=newTemperature-previousTemperature;const newRespiratoryRate=respiratoryRates[0];const previousRespiratoryRate=respiratoryRates[1];const respiratoryRateDifference=newRespiratoryRate-previousRespiratoryRate;const newHeartRate=heartRates[0];const previousHeartRate=heartRates[1];const heartRateDifference=newHeartRate-previousHeartRate;const newSpO2=spO2Values[0];const previousSpO2=spO2Values[1];const spO2Difference=newSpO2-previousSpO2;const weightValues=vitalSignsData.map(data=>data.wt);const lastWeight=weightValues[0];const previousWeight=weightValues[1];const weightDifference=lastWeight-previousWeight;const normalRanges={temperature:{min:36.1,max:37.2},respiratoryRate:{min:12,max:20},heartRate:{min:60,max:100},spO2:{min:95,max:100},weight:{min:50,max:80}};function getNoteAndIconClass(vital,value){const normalRange=normalRanges[vital];let potentialSicknesses="";if(isNaN(value)||value===0){return{note:"No data registered yet",iconClass:"no-data"}}else if(value<normalRange.min){potentialSicknesses="<ul>PS:";switch(vital){case"temperature":potentialSicknesses+="<li>Hypothermia</li><li>Exposure to cold conditions</li><li>Metabolic disorders</li>";break;case"respiratoryRate":potentialSicknesses+="<li>Bradypnea</li><li>Overdose of certain medications</li><li>Neurological disorders</li>";break;case"heartRate":potentialSicknesses+="<li>Bradycardia</li><li>Heart block</li><li>Hypothyroidism</li>";break;case"spO2":potentialSicknesses+="<li>Hypoxemia</li><li>Respiratory distress</li><li>Lung disease</li>";break;case"weight":potentialSicknesses+="<li>Malnutrition</li><li>Eating disorders</li><li>Chronic illness</li>";break;default:potentialSicknesses+="<li>Unknown potential sicknesses</li>"}potentialSicknesses+="</ul>";return{note:`Below normal range: ${potentialSicknesses}`,iconClass:"below-normal"}}else if(value>normalRange.max){potentialSicknesses="<ul>PS:";switch(vital){case"temperature":potentialSicknesses+="<li>Fever</li><li>Infection</li><li>Inflammatory disorders</li>";break;case"respiratoryRate":potentialSicknesses+="<li>Tachypnea</li><li>Respiratory distress</li><li>Anxiety</li><li>Lung diseases</li>";break;case"heartRate":potentialSicknesses+="<li>Tachycardia</li><li>Hypertension</li><li>Anxiety</li><li>Heart disease</li>";break;case"spO2":potentialSicknesses+="<li>Unknown potential sicknesses</li>";break;case"weight":potentialSicknesses+="<li>Overweight</li><li>Obesity</li><li>Metabolic disorders</li>";break;default:potentialSicknesses+="<li>Unknown potential sicknesses</li>"}potentialSicknesses+="</ul>";return{note:`Above normal range: ${potentialSicknesses}`,iconClass:"above-normal"}}else{return{note:`Within normal range.`,iconClass:"normal"}}}const trendAnalysis=`
  <div class="trend-container">
    <div class="trend-box">
      <span class="icon ${getNoteAndIconClass("temperature",previousTemperature).iconClass}"><i class="fas fa-thermometer-half"></i></span>
      <span class="info">
        <strong>Temperature:</strong> ${getNoteAndIconClass("temperature",previousTemperature).note}
      </span>
    </div>
    <div class="trend-box">
      <span class="icon ${getNoteAndIconClass("respiratoryRate",previousRespiratoryRate).iconClass}"><i class="fas fa-lungs"></i></span>
      <span class="info">
        <strong>Respiratory Rate:</strong> ${getNoteAndIconClass("respiratoryRate",previousRespiratoryRate).note}
      </span>
    </div>
    <div class="trend-box">
      <span class="icon ${getNoteAndIconClass("heartRate",previousHeartRate).iconClass}"><i class="fas fa-heartbeat"></i></span>
      <span class="info">
        <strong>Heart Rate:</strong> ${getNoteAndIconClass("heartRate",previousHeartRate).note}
      </span>
    </div>
    <div class="trend-box">
      <span class="icon ${getNoteAndIconClass("spO2",previousSpO2).iconClass}"><i class="fas fa-chart-line"></i></span>
      <span class="info">
        <strong>SpO2 Levels:</strong> ${getNoteAndIconClass("spO2",previousSpO2).note}
      </span>
    </div>
    <div class="trend-box">
      <span class="icon ${getNoteAndIconClass("weight",previousWeight).iconClass}"><i class="fas fa-weight"></i></span>
      <span class="info">
        <strong>Weight:</strong> ${getNoteAndIconClass("weight",previousWeight).note}
      </span>
    </div>
  </div>
`;return{trendAnalysis:trendAnalysis}}function createVisitTrendChart(visitKeys,visitDetails){const visitTrendCanvas=document.getElementById("visitTrendChart");const ctx=visitTrendCanvas.getContext("2d");const vitalSignsData=visitKeys.map(visitKey=>{const visitData=visitDetails[visitKey];return{date:formatDate(visitData.timestamp),temperature:visitData.temperature,bp:visitData.bp,rr:visitData.rr,hr:visitData.hr,sp02:visitData.sp02,wt:visitData.wt,ht:visitData.ht,bmi:visitData.bmi,muac:visitData.muac}});const dates=vitalSignsData.map(data=>data.date);const temperatures=vitalSignsData.map(data=>data.temperature);const respiratoryRates=vitalSignsData.map(data=>data.rr);const heartRates=vitalSignsData.map(data=>data.hr);const spO2Values=vitalSignsData.map(data=>data.sp02);const weightValues=vitalSignsData.map(data=>data.wt);destroyChart();temperatures.reverse();respiratoryRates.reverse();heartRates.reverse();spO2Values.reverse();weightValues.reverse();const{trendAnalysis}=analyzeAndProvideRecommendations(temperatures,respiratoryRates,heartRates,spO2Values,vitalSignsData);window.visitTrendChart=new Chart(ctx,{type:"line",data:{labels:dates.reverse(),datasets:[{label:"Temperature (&deg;C)",data:temperatures,borderColor:"red",fill:false},{label:"Respiratory Rate",data:respiratoryRates,borderColor:"green",fill:false},{label:"Heart Rate",data:heartRates,borderColor:"purple",fill:false},{label:"SpO2 (%)",data:spO2Values,borderColor:"orange",fill:false},{label:"Weight (kg)",data:weightValues,borderColor:"blue",fill:false}]},options:{responsive:true,scales:{x:{display:true,title:{display:true,text:"Date"}},y:{display:true,title:{display:true,text:"Value"}}}}});const trendAnalysisDiv=document.getElementById("trendAnalysisDiv");trendAnalysisDiv.innerHTML=`
    <h3>Trend Analysis:</h3>
    <p>${trendAnalysis}</p>

  `}function displayVisitsPopup(patientName){const visitsRef=ref(database,`patients/${patientName}/visits`);const tableBody=document.getElementById("tableBody");const visitTrendCanvas=document.getElementById("visitTrendChart");tableBody.innerHTML="";visitTrendCanvas.getContext("2d").clearRect(0,0,visitTrendCanvas.width,visitTrendCanvas.height);onValue(visitsRef,snapshot=>{const visitDetails=snapshot.val();if(visitDetails){const visitKeys=Object.keys(visitDetails);visitKeys.sort((a,b)=>visitDetails[b].timestamp-visitDetails[a].timestamp);visitKeys.forEach(visitKey=>{const visitData=visitDetails[visitKey];const row=document.createElement("tr");row.innerHTML=`
          <td>${formatDate(visitData.timestamp)}</td>
          <td>${visitData.clinicianName}</td>
          <td>${visitData.temperature} &deg;C</td>
          <td>${visitData.bp}</td>
          <td>${visitData.rr}</td>
          <td>${visitData.hr}</td>
          <td>${visitData.sp02}</td>
          <td>${visitData.wt}</td>
          <td>${visitData.ht}</td>
          <td>${visitData.bmi}</td>
          <td>${visitData.muac}</td>
          <td>${visitData.weightForAgeZScore}</td>
          <td>${visitData.disability}</td>
          <td>${visitData.chronicIllness}</td>
          <td>${visitData.drugAbuse}</td>
          <td>${visitData.allergies.join(", ")}</td>
        `;tableBody.appendChild(row)});createVisitTrendChart(visitKeys,visitDetails)}else{const noVisitsRow=document.createElement("tr");noVisitsRow.innerHTML='<td colspan="17">No visit details found.</td>';tableBody.appendChild(noVisitsRow)}});const popupOverlay=document.getElementById("popup-overlay4");popupOverlay.style.display="block"}function formatDate(timestamp){const date=new Date(timestamp);const options={year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"};return date.toLocaleString("en-US",options)}const closePopupBtn4=document.getElementById("closePopupBtn4");closePopupBtn4.addEventListener("click",()=>{const popupOverlay=document.getElementById("popup-overlay4");popupOverlay.style.display="none"});let currentPatientName=patient.patientId;const triageButton=document.getElementById("triageButton");triageButton.addEventListener("click",()=>{displayVisitsPopup(patientName)});function createRecordElement(recordKey,record){const recordElement=document.createElement("div");recordElement.classList.add("record");const recordKeyElement=document.createElement("h4");recordKeyElement.textContent="Record Key: "+recordKey;recordElement.appendChild(recordKeyElement);const table=document.createElement("table");recordElement.appendChild(table);const recordKeyRow=document.createElement("tr");table.appendChild(recordKeyRow);const recordKeyHeader=document.createElement("th");recordKeyHeader.textContent="Record Key";recordKeyRow.appendChild(recordKeyHeader);const recordKeyData=document.createElement("td");recordKeyData.textContent=recordKey;recordKeyRow.appendChild(recordKeyData);const dateTakenRow=document.createElement("tr");table.appendChild(dateTakenRow);const dateTakenHeader=document.createElement("th");dateTakenHeader.textContent="Date Taken";dateTakenRow.appendChild(dateTakenHeader);const dateTakenElement=document.createElement("td");const dateTaken=new Date(parseInt(record.dateTaken));if(!isNaN(dateTaken.getTime())){dateTakenElement.textContent=dateTaken.toLocaleString()}else{dateTakenElement.textContent="Invalid Date"}dateTakenRow.appendChild(dateTakenElement);const testsTakenRow=document.createElement("tr");table.appendChild(testsTakenRow);const testsTakenHeader=document.createElement("th");testsTakenHeader.textContent="Services Offered";testsTakenRow.appendChild(testsTakenHeader);const testsTakenElement=document.createElement("td");testsTakenElement.textContent=record.testsTaken;testsTakenRow.appendChild(testsTakenElement);const paymentStatusRow=document.createElement("tr");table.appendChild(paymentStatusRow);const paymentStatusHeader=document.createElement("th");paymentStatusHeader.textContent="Service Payment";paymentStatusRow.appendChild(paymentStatusHeader);const paymentStatusElement=document.createElement("td");paymentStatusElement.textContent=record.paymentstatus||"Not Paid";paymentStatusRow.appendChild(paymentStatusElement);if(record.paymentstatus!=="payment received"){paymentStatusElement.style.color="red"}else{paymentStatusElement.style.color="blue"}const medicineStatusRow=document.createElement("tr");table.appendChild(medicineStatusRow);const medicineStatusHeader=document.createElement("th");medicineStatusHeader.textContent="Medicine Payment";medicineStatusRow.appendChild(medicineStatusHeader);const medicineStatusData=document.createElement("td");medicineStatusData.textContent=record.medicinestatus||"Not Paid";medicineStatusRow.appendChild(medicineStatusData);if(record.medicinestatus!=="payment received"){medicineStatusData.style.color="red"}else{medicineStatusData.style.color="blue"}const resultsObtainedRow=document.createElement("tr");table.appendChild(resultsObtainedRow);const resultsObtainedHeader=document.createElement("th");resultsObtainedHeader.textContent="Test Results status";resultsObtainedRow.appendChild(resultsObtainedHeader);const resultsObtainedElement=document.createElement("td");resultsObtainedElement.textContent=record.results?.resultsObtained||"Pending...";resultsObtainedElement.classList.add("results-obtained-data");if(record.results&&record.results.resultsObtained==="Completed Successfully"){resultsObtainedElement.style.color="darkblue"}else{resultsObtainedElement.style.color="orange"}resultsObtainedRow.appendChild(resultsObtainedElement);const additionalNotesRow=document.createElement("tr");table.appendChild(additionalNotesRow);const additionalNotesHeader=document.createElement("th");additionalNotesHeader.textContent="Diagnosis";additionalNotesRow.appendChild(additionalNotesHeader);const additionalNotesElement=document.createElement("td");additionalNotesElement.textContent=record.results?.additionalNotes||"Pending...";if(record.results&&!record.results.additionalNotes){additionalNotesElement.classList.add("pending")}additionalNotesRow.appendChild(additionalNotesElement);const finalStatusRow=document.createElement("tr");table.appendChild(finalStatusRow);const finalStatusHeader=document.createElement("th");finalStatusHeader.textContent="Final Status of Patient";finalStatusRow.appendChild(finalStatusHeader);const finalStatusData=document.createElement("td");finalStatusData.textContent=record.results?.finalStatus||"Pending...";finalStatusRow.appendChild(finalStatusData);const followUpRow=document.createElement("tr");table.appendChild(followUpRow);const followUpHeader=document.createElement("th");followUpHeader.textContent="Follow-up Date/Time";followUpRow.appendChild(followUpHeader);const followUpData=document.createElement("td");followUpData.textContent=record.results?.followUpDateTime||"none";followUpRow.appendChild(followUpData);const medicationTakenElement=document.createElement("div");medicationTakenElement.classList.add("medication-taken");const medicationTable=document.createElement("table");medicationTable.classList.add("medication-table");const tableHeaderRow=document.createElement("tr");const headers=["Medication","Prescription","Milligrams","Cost"];headers.forEach(headerText=>{const tableHeaderCell=document.createElement("th");tableHeaderCell.textContent=headerText;tableHeaderRow.appendChild(tableHeaderCell)});medicationTable.appendChild(tableHeaderRow);let totalCost=0;if(record.results&&record.results.medication){const medicationNodes=record.results.medication;Object.keys(medicationNodes).forEach(medicationKey=>{const medicationData=medicationNodes[medicationKey];const tableRow=document.createElement("tr");const medicationCell=document.createElement("td");medicationCell.textContent=medicationData.medication;const prescriptionCell=document.createElement("td");prescriptionCell.textContent=medicationData.prescription;const gramsCell=document.createElement("td");gramsCell.textContent=medicationData.grams;const totalCostCell=document.createElement("td");totalCostCell.textContent=medicationData.totalCost;tableRow.appendChild(medicationCell);tableRow.appendChild(prescriptionCell);tableRow.appendChild(gramsCell);tableRow.appendChild(totalCostCell);medicationTable.appendChild(tableRow);totalCost+=parseFloat(medicationData.totalCost)})}medicationTakenElement.appendChild(medicationTable);recordElement.appendChild(medicationTakenElement);const totalRow=document.createElement("tr");medicationTable.appendChild(totalRow);const emptyCell=document.createElement("td");emptyCell.setAttribute("colspan","3");totalRow.appendChild(emptyCell);const totalCostCell=document.createElement("td");totalCostCell.textContent="Total Cost: UGX "+totalCost.toFixed(2);totalCostCell.classList.add("total-cell");totalRow.appendChild(totalCostCell);const shareButton=document.createElement("button");shareButton.id="shareButton";shareButton.innerHTML='<i class="fa fa-bell"></i> Notify';shareButton.addEventListener("click",()=>{shareRecord(patient,record)});function shareRecord(patient,record){const patientName=patient.name;const testKey=recordKey;const message=`Results for ${testKey} for patient ${patientName} are ready.`;const notification={timestamp:Date.now(),message:message};const chatRef=ref(database,"lab-results");push(chatRef,notification).then(()=>{console.log("Notification sent successfully!");showMessage("Notification sent successfully!")}).catch(error=>{console.error("Error sending notification:",error);showMessage("Error sending notification:",error)})}let visitKeys=[];let visitDetails={};function displayPatientVisitDetails(visitKeys,visitDetails,latestVisitData){const patientVisitDetailsDiv=document.getElementById("patientVisitDetails");patientVisitDetailsDiv.innerHTML="";if(latestVisitData){const visitCount=visitKeys.length;const visitCountElement=document.getElementById("visitCount");visitCountElement.textContent=visitCount;const visitElement=document.createElement("div");visitElement.innerHTML=`
    <h3>LATEST VISIT TRIAGE:</h3>
    <div class="visit-details-container">
      <p><b>Date:</b> ${formatDate(latestVisitData.timestamp)}</p>
      <p><b>Clinician's Name:</b> ${latestVisitData.clinicianName||"N/D"}</p>
      <p><b>Temperature:</b> ${latestVisitData.temperature||"N/D"} &deg;C</p>
      <p><b>BP:</b> ${latestVisitData.bp||"N/D"} (mmHg)</p>
      <p><b>RR:</b> ${latestVisitData.rr||"N/D"}</p>
      <p><b>HR:</b> ${latestVisitData.hr||"N/D"}</p>
      <p><b>SpO2:</b> ${latestVisitData.sp02||"N/D"} (%)</p>
      <p><b>WT:</b> ${latestVisitData.wt||"N/D"} (Kg)</p>
      <p><b>HT:</b> ${latestVisitData.ht||"N/D"} (Cm)</p>
      <p><b>BMI:</b> ${latestVisitData.bmi||"N/D"}</p>
      <p><b>MUAC:</b> ${latestVisitData.muac||"N/D"}</p>
      <p><b>Weight for Age Z score:</b> ${latestVisitData.weightForAgeZScore||"N/D"} (Kg)</p>
      <p><b>Disability:</b> ${latestVisitData.disability||"N/D"}</p>
      <p><b>Known Chronic Illness:</b> ${latestVisitData.chronicIllness||"N/D"}</p>
      <p><b>Any Drug Abuse:</b> ${latestVisitData.drugAbuse||"N/D"}</p>
      <p><b>Allergies:</b> ${latestVisitData.allergies&&latestVisitData.allergies.length>0?latestVisitData.allergies.join(", "):"N/D"}
      </p>
    </div>
    <hr>
    `;patientVisitDetailsDiv.appendChild(visitElement)}else{patientVisitDetailsDiv.textContent="No visit details found.";patientVisitDetailsDiv.style.fontStyle="italic"}}function getPatientDetails(patientName){const patientRef=ref(database,`patients/${patientName}`);return get(patientRef).then(snapshot=>{if(snapshot.exists()){return snapshot.val()}else{return null}}).catch(error=>{console.error("Error fetching patient details:",error);return null})}function getLatestVisitData(patientName){const visitsRef=ref(database,`patients/${patientName}/visits`);return get(visitsRef).then(snapshot=>{const visitDetails=snapshot.val();if(visitDetails){const visitKeys=Object.keys(visitDetails).sort((a,b)=>visitDetails[b].timestamp-visitDetails[a].timestamp);const latestVisitKey=visitKeys[0];const latestVisitData=visitDetails[latestVisitKey];return latestVisitData}else{return null}}).catch(error=>{console.error("Error fetching latest visit data:",error);return null})}function getPatientVisitDetails(patientName){const visitsRef=ref(database,`patients/${patientName}/visits`);onValue(visitsRef,snapshot=>{const visitDetails=snapshot.val();if(visitDetails){visitKeys=Object.keys(visitDetails).sort((a,b)=>visitDetails[b].timestamp-visitDetails[a].timestamp);const latestVisitKey=visitKeys[0];const latestVisitData=visitDetails[latestVisitKey];displayPatientVisitDetails(visitKeys,visitDetails,latestVisitData);createVisitTrendChart(visitKeys,visitDetails)}else{displayPatientVisitDetails([],{});createVisitTrendChart([],{})}})}getPatientVisitDetails(patientName);const printButton=document.createElement("button");printButton.innerHTML='<i class="fa fa-print"></i> Print Record';printButton.classList.add("print-button");printButton.addEventListener("click",async()=>{const patient=await getPatientDetails(patientName);const latestVisitData=await getLatestVisitData(patientName);printRecord(patient,record,visitKeys,visitDetails,latestVisitData)});recordElement.appendChild(printButton);function printRecord(patient,record,visitKeys,visitDetails,latestVisitData){window.jsPDF=window.jspdf.jsPDF;const doc=new jsPDF;doc.setFontSize(20);const hospitalLogo="k.jpg";const headerBoxX=20;const headerBoxY=10;const headerBoxWidth=170;const headerBoxHeight=40;doc.setFillColor(255,255,255);doc.rect(headerBoxX,headerBoxY,headerBoxWidth,headerBoxHeight,"F");const headerBoxCenterX=headerBoxX+headerBoxWidth/2;const headerBoxCenterY=headerBoxY+headerBoxHeight/2;doc.addImage(hospitalLogo,"PNG",headerBoxX-10,headerBoxY-5,55,55);const hospitalName="KEAH MEDICAL CENTER ";const hospitalNameWidth=doc.getTextWidth(hospitalName);const hospitalNameY=headerBoxCenterY-5;doc.setFont("helvetica","bold");doc.setFontSize(28);doc.setTextColor(0,0,0);doc.text(hospitalName,headerBoxCenterX,hospitalNameY,{align:"center"});const hospitalAddress="Plot 294 Kevina Road, Nsambya- Kampala";const hospitalAddressY=headerBoxCenterY+6;doc.setFont("helvetica","normal");doc.setFontSize(12);doc.text(hospitalAddress,headerBoxCenterX,hospitalAddressY,{align:"center"});const telephoneContacts="Tel: +256 782 477 517, Email: info@keahmedicals.com";const telephoneContactsY=headerBoxCenterY+15;doc.setFont("helvetica","normal");doc.setFontSize(10);doc.text(telephoneContacts,headerBoxCenterX,telephoneContactsY,{align:"center"});doc.setFont("helvetica","normal");doc.setFont("helvetica","bold");doc.setFontSize(13);const reportHeading="LABORATORY REPORT";const reportHeadingWidth=doc.getTextWidth(reportHeading);const reportHeadingX=(doc.internal.pageSize.getWidth()-reportHeadingWidth)/2;const reportHeadingY=headerBoxY+headerBoxHeight+10;doc.text(reportHeading,reportHeadingX,reportHeadingY);doc.setFont("helvetica","normal");doc.setFontSize(12);const patientDetails=[["Patient Name",patient.name,"Record key:   "+recordKey],["Date of Birth",patient.dob,"Date taken:   "+dateTakenElement.textContent],["Payment Type",patient.payment,"Test taken:   "+testsTakenElement.textContent],["Residence",patient.residence,"Service Payment:   "+paymentStatusElement.textContent],["Contact",patient.parents,"Test Results status:   "+resultsObtainedElement.textContent],["Patient ID",patient.patientId,"Diagnosis:   "+additionalNotesElement.textContent]];const patientTableX=20;const patientTableY=reportHeadingY+5;const patientTableOptions={startX:patientTableX,startY:patientTableY,margin:{top:8},styles:{font:"helvetica",fontStyle:"normal",fontSize:8},headStyles:{fillColor:[0,128,0],fontStyle:"bold"},bodyStyles:{fillColor:255},columnStyles:{0:{cellWidth:55},1:{cellWidth:55},2:{cellWidth:70}}};doc.autoTable({head:[["Field","Value","Test Details"]],body:patientDetails,...patientTableOptions});doc.setFont("helvetica","bold");doc.setFontSize(16);const latestVisitHeading="LATEST VISIT TRIAGE";const latestVisitHeadingWidth=doc.getTextWidth(latestVisitHeading);const latestVisitHeadingX=(doc.internal.pageSize.getWidth()-latestVisitHeadingWidth)/2;const latestVisitHeadingY=patientTableY+65;doc.text(latestVisitHeading,latestVisitHeadingX,latestVisitHeadingY);doc.setFont("helvetica","normal");doc.setFontSize(8);const latestVisitTableX=20;const latestVisitTableY=latestVisitHeadingY+5;const latestVisitTableOptions={startX:latestVisitTableX,startY:latestVisitTableY,margin:{top:8},styles:{font:"helvetica",fontStyle:"normal",fontSize:7},headStyles:{fillColor:[0,128,0],fontStyle:"bold"},bodyStyles:{fillColor:255},columnStyles:{0:{cellWidth:45},1:{cellWidth:45},2:{cellWidth:45},3:{cellWidth:45}}};const latestVisitDetails=[];if(latestVisitData){latestVisitDetails.push(["Date",formatDate(latestVisitData.timestamp),"Clinician's Name",latestVisitData.clinicianName||"N/D"],["Temperature",latestVisitData.temperature||"N/D","BP",latestVisitData.bp||"N/D"],["RR",latestVisitData.rr||"N/D","HR",latestVisitData.hr||"N/D"],["SpO2",latestVisitData.sp02||"N/D","WT",latestVisitData.wt||"N/D"],["HT",latestVisitData.ht||"N/D","BMI",latestVisitData.bmi||"N/D"],["MUAC",latestVisitData.muac||"N/D","Weight for Age Z score",latestVisitData.weightForAgeZScore||"N/D"],["Disability",latestVisitData.disability||"N/D","Known Chronic Illness",latestVisitData.chronicIllness||"N/D"],["Any Drug Abuse",latestVisitData.drugAbuse||"N/D","Allergies",latestVisitData.allergies&&latestVisitData.allergies.length>0?latestVisitData.allergies.join(", "):"N/D"])}else{latestVisitDetails.push(["Date","N/A","Clinician's Name","N/A"],["Temperature","N/A","BP","N/A"],["RR","N/A","HR","N/A"],["SpO2","N/A","WT","N/A"],["HT","N/A","BMI","N/A"],["MUAC","N/A","Weight for Age Z score","N/A"],["Disability","N/A","Known Chronic Illness","N/A"],["Any Drug Abuse","N/A","Allergies","N/A"])}doc.autoTable({head:[["Field","Value","Field","Value"]],body:latestVisitDetails,...latestVisitTableOptions});const medicationTableData=[];const medicationRows=medicationTable.querySelectorAll("tr");for(let i=1;i<medicationRows.length;i++){const cells=medicationRows[i].querySelectorAll("td");if(cells.length===4){const medication=cells[0].textContent;const prescription=cells[1].textContent;const grams=cells[2].textContent;medicationTableData.push([medication,prescription,grams])}}doc.autoTable({startY:200,head:[["Medication","Prescription","Milligrams"]],body:medicationTableData,theme:"grid",styles:{fontSize:8,cellPadding:1.3,lineColor:[0,0,0],lineWidth:.1},columnStyles:{0:{cellWidth:50},1:{cellWidth:50},2:{cellWidth:40}}});const signatureLabelX=20;const signatureLabelY=doc.internal.pageSize.getHeight()-20;doc.setFont("helvetica","normal");doc.setFontSize(12);doc.text("Doctor's Signature:",signatureLabelX,signatureLabelY,{align:"left"});doc.autoPrint();doc.output("dataurlnewwindow")}const deleteButton=document.createElement("button");deleteButton.classList.add("delete-button");const binIcon=document.createElement("i");binIcon.classList.add("fa","fa-trash");deleteButton.innerHTML="";deleteButton.appendChild(binIcon);deleteButton.innerHTML+=" Delete";deleteButton.addEventListener("click",()=>{const recordKey=recordKeyElement.getAttribute("data-record-key");deleteRecord(recordKey)});const finnishButton=document.createElement("button");finnishButton.textContent="Done ";const tickIcon=document.createElement("i");tickIcon.classList.add("fas","fa-check");finnishButton.appendChild(tickIcon);finnishButton.classList.add("finnish-button");const addMedicationForm=document.getElementById("addMedicationForm");finnishButton.addEventListener("click",()=>{const recordKey=recordKeyElement.textContent.replace("Record Key: ","");const testRef=ref(database,`patients/${currentPatientName}/testsTaken/${recordKey}`);update(testRef,{resultsObtained:"Completed Successfully"}).then(()=>{showMessage("Test status saved successfully!");resultsObtainedData.textContent="Completed Successfully";resultsObtainedData.style.color="darkblue"}).catch(error=>{console.error("Error saving test status:",error)});shareRecord(patient,record)});const uploadResultsInput=document.createElement("input");uploadResultsInput.type="file";uploadResultsInput.classList.add("upload-results-input");uploadResultsInput.accept=".pdf";const uploadButton=document.createElement("button");uploadButton.textContent="Upload";uploadButton.classList.add("upload-button");uploadButton.addEventListener("click",()=>{uploadButton.innerHTML='<i class="fas fa-spinner fa-spin"></i> Uploading...';const selectedFile=uploadResultsInput.files[0];if(selectedFile){const patientName=patient.patientId;const filename=`${patientName}_${Date.now()}_${selectedFile.name}`;const fileRef=storageRef(storage,`results/${filename}`);uploadBytes(fileRef,selectedFile).then(snapshot=>{getDownloadURL(snapshot.ref).then(downloadURL=>{const patientRef=ref(database,`patients/${patientName}/testsTaken/${recordKey}`);update(patientRef,{resultFileURL:downloadURL});finnishButtonFunction();showMessage("File uploaded successfully!")})}).catch(error=>{console.error("Error uploading file:",error);showMessage("Error uploading file. Please try again.")}).finally(()=>{uploadButton.textContent="Upload"})}else{showMessage("No file selected.");uploadButton.textContent="Upload"}});function finnishButtonFunction(){const recordKey=recordKeyElement.textContent.replace("Record Key: ","");const testRef=ref(database,`patients/${currentPatientName}/testsTaken/${recordKey}`);update(testRef,{resultsObtained:"Completed Successfully"}).then(()=>{showMessage("Test status saved successfully!");resultsObtainedData.textContent="Completed Successfully";resultsObtainedData.style.color="darkblue"}).catch(error=>{console.error("Error saving test status:",error)});shareRecord(patient,record)}const viewResultsButton=document.createElement("button");viewResultsButton.textContent="View Results";viewResultsButton.classList.add("view-results-button");const iconElement=document.createElement("i");iconElement.classList.add("fas","fa-eye");viewResultsButton.appendChild(iconElement);viewResultsButton.addEventListener("click",()=>{const patientName=patient.patientId;const recordKey=recordKeyElement.textContent.replace("Record Key: ","");const testRef=ref(database,`patients/${patientName}/testsTaken/${recordKey}`);get(testRef).then(snapshot=>{const testData=snapshot.val();if(testData&&testData.resultFileURL){const fileURL=testData.resultFileURL;window.open(fileURL,"_blank")}else{showMessage("No results file available.")}}).catch(error=>{console.error("Error retrieving file URL:",error);showMessage("Error retrieving file URL. Please try again.")})});recordElement.appendChild(viewResultsButton);recordElement.appendChild(uploadResultsInput);recordElement.appendChild(uploadButton);recordKeyElement.setAttribute("data-record-key",recordKey);return recordElement}const testSearchInput=document.getElementById("testSearch");testSearchInput.addEventListener("input",()=>{const searchTerm=testSearchInput.value.toLowerCase();const testRecordElements=document.querySelectorAll(".record");testRecordElements.forEach(recordElement=>{const recordKeyElement=recordElement.querySelector("h4");if(recordKeyElement){const recordKey=recordKeyElement.textContent.toLowerCase();if(recordKey.includes(searchTerm)){recordElement.style.display="block"}else{recordElement.style.display="none"}}})});function deleteRecord(recordKey){const patientName=patient.name;const confirmation=confirm("Are you sure you want to delete this record?");if(confirmation){const password=prompt("Please enter your password to confirm the deletion:");if(password==="mm"){const recordRef=ref(database,`patients/${patientName}/testsTaken/${recordKey}`);remove(recordRef).then(()=>{alert("Record deleted successfully!")}).catch(error=>{console.error("Error deleting record:",error);alert("Error deleting record. Please try again.")})}else{alert("Wrong password. Deletion cancelled.")}}}}const labRequestsPopupOverlay=document.getElementById("labRequestsPopupOverlay");let latestLabRequestMessage="";const shownMessages=new Set;function showRequestMessage(message){const notificationContainer=document.createElement("div");notificationContainer.className="request-notification";notificationContainer.textContent=message;document.body.appendChild(notificationContainer);setTimeout(()=>{notificationContainer.remove()},9e3)}function playNotificationSound(){const audio=new Audio("new-notification-on-your-device-138695.mp3");audio.play()}function showNotification(message,timestamp){if(!shownMessages.has(timestamp)){playNotificationSound();shownMessages.add(timestamp)}}const labRequestsCache=[];function retrieveAndDisplayLabRequests(){const labRequestsList=document.getElementById("labRequestsList");labRequestsList.innerHTML="";const chatRef=ref(database,"laboratory-requests");onValue(chatRef,snapshot=>{try{if(snapshot.exists()){let notDoneCount=0;const notDoneBtn=document.getElementById("notDoneBtn");const completedBtn=document.getElementById("completedBtn");notDoneBtn.addEventListener("click",()=>{applyFilter("Not Yet Done")});completedBtn.addEventListener("click",()=>{applyFilter("Completed")});function applyFilter(filter){const labRequestsList=document.getElementById("labRequestsList");const labRequestItems=labRequestsList.querySelectorAll("li");labRequestItems.forEach(item=>{const status=item.getAttribute("data-status");if(status===filter||filter==="All"){item.style.display="block"}else{item.style.display="none"}});const filterButtons=document.querySelectorAll(".filter-button");filterButtons.forEach(button=>{if(button.textContent===filter){button.classList.add("active")}else{button.classList.remove("active")}})}snapshot.forEach(childSnapshot=>{const messageId=childSnapshot.key;if(!labRequestsCache.includes(messageId)){labRequestsCache.push(messageId);showNotification(childSnapshot.val().message,messageId)}const labRequest=childSnapshot.val().message;const status=childSnapshot.val().status||"Not Yet Done";const listItem=document.createElement("li");listItem.id=messageId;listItem.setAttribute("data-status",status);const messageContent=document.createElement("span");messageContent.textContent=labRequest;listItem.appendChild(messageContent);const messageStatus=document.createElement("span");messageStatus.textContent=status;messageStatus.classList.add("time-status");listItem.appendChild(messageStatus);const markAsDoneBtn=document.createElement("button");markAsDoneBtn.textContent="Done";markAsDoneBtn.classList.add("button-done");markAsDoneBtn.addEventListener("click",()=>{markMessageAsDone(messageId)});listItem.appendChild(markAsDoneBtn);labRequestsList.appendChild(listItem);if(status==="Not Yet Done"){notDoneCount++;messageStatus.style.color="red";latestLabRequestMessage=labRequest}else if(status==="Completed"){markAsDoneBtn.style.display="none"}});const notDoneCountSpan=document.getElementById("notDoneCount");notDoneCountSpan.textContent=notDoneCount}else{const noLabRequestsItem=document.createElement("li");noLabRequestsItem.textContent="No lab requests found.";labRequestsList.appendChild(noLabRequestsItem)}}catch(error){console.error("Error retrieving lab requests:",error);showMessage("Error retrieving lab requests:",error)}})}const envelopeIcon=document.getElementById("envelope-icon");let labRequestsListener;envelopeIcon.addEventListener("click",()=>{retrieveAndDisplayLabRequests();openLabRequestsPopup()});document.addEventListener("DOMContentLoaded",()=>{retrieveAndDisplayLabRequests()});function markMessageAsDone(messageId){const messageRef=ref(database,`laboratory-requests/${messageId}`);update(messageRef,{status:"Completed",timestamp:Date.now()}).then(()=>{console.log("Message marked as done successfully!");retrieveAndDisplayLabRequests()}).catch(error=>{console.error("Error marking message as done:",error);showMessage("Error marking message as done:",error)})}function formatDate(timestamp){const date=new Date(timestamp);const options={year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric"};return date.toLocaleString(undefined,options)}function openLabRequestsPopup(){const labRequestsPopupOverlay=document.getElementById("labRequestsPopupOverlay");labRequestsPopupOverlay.style.display="block"}function closeLabRequestsPopup(){const labRequestsPopupOverlay=document.getElementById("labRequestsPopupOverlay");labRequestsPopupOverlay.style.display="none";const labRequestsList=document.getElementById("labRequestsList");labRequestsList.innerHTML=""}const labRequestsPopupClose=document.getElementById("labRequestsPopupClose");labRequestsPopupClose.addEventListener("click",closeLabRequestsPopup);window.addEventListener("click",event=>{const labRequestsPopupOverlay=document.getElementById("labRequestsPopupOverlay");if(event.target===labRequestsPopupOverlay){closeLabRequestsPopup()}});const addMedicationBtn=document.getElementById("addMedicationBtn");const addRecordPopupOverlay=document.getElementById("addRecordPopupOverlay");const addRecordPopupClose=document.getElementById("addRecordPopupClose");addMedicationBtn.addEventListener("click",()=>{addRecordPopupOverlay.style.visibility="visible";addRecordPopupOverlay.style.opacity="1"});addRecordPopupClose.addEventListener("click",()=>{addRecordPopupOverlay.style.visibility="hidden";addRecordPopupOverlay.style.opacity="0"});const loaderElement=document.getElementById("loader");loaderElement.classList.remove("hidden");onValue(patientsRef,snapshot=>{const patientsData=snapshot.val();if(patientsData){patients=Object.values(patientsData);renderPatients(patients)}loaderElement.classList.add("hidden")});const calculateTotal=()=>{const medicationCost=parseFloat(medicationInput.selectedOptions[0].dataset.costPerGram);const gramsValue=parseFloat(gramsInput.value);const total=medicationCost*gramsValue;totalElement.textContent="Total: $"+total.toFixed(2)};const createMedicationInput=()=>{const medicationInputContainer=document.createElement("div");medicationInputContainer.classList.add("medication-input-container");const medicationLabel=document.createElement("label");medicationLabel.textContent="Medicine:";medicationLabel.setAttribute("for","medicationInput");const medicationInput=document.createElement("select");medicationInput.required=true;medicationInput.classList.add("select2");const medicineRef=ref(database,"medicine");onValue(medicineRef,snapshot=>{const medicineData=snapshot.val();if(medicineData){Object.values(medicineData).forEach(medicine=>{const option=document.createElement("option");option.value=medicine.name;option.text=medicine.name;option.dataset.costPerGram=medicine.pricepergram;medicationInput.appendChild(option)});$(medicationInput).select2({dropdownParent:medicationInputContainer})}});const prescriptionLabel=document.createElement("label");prescriptionLabel.textContent="Prescription:";prescriptionLabel.setAttribute("for","prescriptionInput");const prescriptionInput=document.createElement("select");prescriptionInput.required=true;prescriptionInput.classList.add("select2");const prescriptionsRef=ref(database,"prescriptions");onValue(prescriptionsRef,snapshot=>{const prescriptionsData=snapshot.val();prescriptionInput.innerHTML="";if(prescriptionsData){const prescriptions=Object.values(prescriptionsData);prescriptions.forEach(prescription=>{const option=document.createElement("option");option.value=prescription.prescription;option.text=prescription.prescription;prescriptionInput.appendChild(option)})}});const gramsLabel=document.createElement("label");gramsLabel.textContent="Milligrams:";gramsLabel.setAttribute("for","gramsInput");const gramsInput=document.createElement("input");gramsInput.type="number";gramsInput.step="any";gramsInput.placeholder="Milligrams";const costPerGramLabel=document.createElement("label");costPerGramLabel.textContent="Cost of Milligrams:";costPerGramLabel.setAttribute("for","costPerGramOutput");const costPerGramOutput=document.createElement("output");costPerGramOutput.classList.add("cost-per-gram-output");costPerGramOutput.value="";const deleteButton=document.createElement("button");deleteButton.classList.add("delete-medication-button");deleteButton.innerHTML='<i class="fa fa-trash"></i>';deleteButton.addEventListener("click",()=>{medicationInputContainer.remove()});gramsInput.addEventListener("input",()=>{const gramsValue=parseFloat(gramsInput.value);const selectedOption=medicationInput.options[medicationInput.selectedIndex];const costPerGram=parseFloat(selectedOption.dataset.costPerGram);const totalCost=gramsValue*costPerGram;costPerGramOutput.value=totalCost.toFixed(2)});medicationInputContainer.appendChild(medicationLabel);medicationInputContainer.appendChild(medicationInput);medicationInputContainer.appendChild(prescriptionLabel);medicationInputContainer.appendChild(prescriptionInput);medicationInputContainer.appendChild(gramsLabel);medicationInputContainer.appendChild(gramsInput);medicationInputContainer.appendChild(costPerGramLabel);medicationInputContainer.appendChild(costPerGramOutput);medicationInputContainer.appendChild(deleteButton);const submitMedicationButton=document.createElement("button");submitMedicationButton.type="button";submitMedicationButton.textContent="Submit Medication";submitMedicationButton.classList.add("submit-medication-button");submitMedicationButton.addEventListener("click",()=>{const medicationRecord={medication:medicationInput.value,prescription:prescriptionInput.value,grams:parseFloat(gramsInput.value),totalCost:parseFloat(costPerGramOutput.value.replace(/,/g,""))};const recordKeyInput=document.querySelector('input[name="recordKey"]');const recordKey=recordKeyInput.value;const patientRef=ref(database,`patients/${currentPatientName}/testsTaken/${recordKey}/results/medication`);const newRecordRef=push(patientRef);set(newRecordRef,medicationRecord).then(()=>{showMessage("Medication submitted successfully!")}).catch(error=>{console.error("Error submitting medication:",error);showMessage("Error submitting medication. Please try again.")})});medicationInputContainer.appendChild(submitMedicationButton);return medicationInputContainer};const addMedicationButton=document.getElementById("addMedicationButton");const medicationContainer=document.getElementById("medicationInputsContainer");addMedicationButton.addEventListener("click",()=>{const medicationInput=createMedicationInput();medicationContainer.appendChild(medicationInput);$(medicationInput).find("select.select2").select2()});const medicationInputs=document.querySelectorAll(".medication-input-container");medicationInputs.forEach(medicationInput=>{const gramsInput=medicationInput.querySelector('input[type="number"]')});const testsTakenSelect=document.getElementById("testsTaken");testsTakenSelect.addEventListener("change",()=>{});const testsRef=ref(database,"tests");onValue(testsRef,snapshot=>{const testsData=snapshot.val();testsTakenSelect.innerHTML="";if(testsData){const tests=Object.values(testsData);tests.forEach(test=>{const option=document.createElement("option");option.value=test.name+"      "+"Price: UGX "+test.dob+".00";option.textContent=test.name+"      "+"Price: UGX "+test.dob+".00";option.dataset.dob=test.dob;testsTakenSelect.appendChild(option)})}});const addRecordForm=document.getElementById("addRecordForm");let currentPatientName="";function showMessage(message){const messageElement=document.getElementById("message");messageElement.textContent=message;messageElement.style.display="block";setTimeout(()=>{messageElement.style.display="none"},4e3)}showMessage("");addRecordForm.addEventListener("submit",function(e){e.preventDefault();const patientName=currentPatientName;const medicationInputs=document.querySelectorAll(".medication-input-container");const testsTakenSelect=document.getElementById("testsTaken");const selectedTestOption=testsTakenSelect.options[testsTakenSelect.selectedIndex];const testsTaken=selectedTestOption?selectedTestOption.value:"";const resultsObtained=document.getElementById("resultsObtained").value;const additionalNotes=document.getElementById("additionalNotes").value;const dateTaken=Date.now();const recordData={testsTaken:testsTaken,resultsObtained:resultsObtained,additionalNotes:additionalNotes,dateTaken:dateTaken};const patientRef=ref(database,`patients/${patientName}`);const testsTakenRef=child(patientRef,"testsTaken");get(testsTakenRef).then(snapshot=>{const testsData=snapshot.val();const testCount=testsData?Object.keys(testsData).length:0;const newTestNumber=testCount+1;const newRecordRef=child(testsTakenRef,"test"+newTestNumber);set(newRecordRef,recordData).then(()=>{medicationInputs.forEach(medicationInput=>{const medicationSelect=medicationInput.querySelector('select[name="medication"]');const prescriptionSelect=medicationInput.querySelector('select[name="prescription"]');const gramsInput=medicationInput.querySelector('input[name="grams"]');const costPerGramOutput=medicationInput.querySelector(".cost-per-gram-output");if(medicationSelect&&prescriptionSelect&&gramsInput&&costPerGramOutput){const medicationRecord={medication:medicationSelect.value,prescription:prescriptionSelect.value,grams:parseFloat(gramsInput.value),totalCost:parseFloat(costPerGramOutput.value.replace(/,/g,""))};const medicationRef=child(newRecordRef,"medication");push(medicationRef,medicationRecord)}}).catch(error=>{console.error("Error saving new record:",error)})}).catch(error=>{console.error("Error retrieving existing records:",error)});addRecordForm.reset();showMessage("Record added successfully!")}).catch(error=>{console.error("Error adding record:",error);showMessage("Error adding record. Please try again.")})});const submitMedicationBtn=document.getElementById("submitMedicationButton");submitMedicationBtn.addEventListener("click",event=>{event.preventDefault();const medicationRecord={resultsObtained:document.getElementById("resultsObtained").value,additionalNotes:document.getElementById("additionalNotes").value};const recordKeyInput=document.querySelector('input[name="recordKey"]');const recordKey=recordKeyInput.value;const patientRef=ref(database,`patients/${currentPatientName}/testsTaken/${recordKey}/results`);set(patientRef,medicationRecord).then(()=>{showMessage("Medication submitted successfully!")}).catch(error=>{console.error("Error submitting medication:",error);showMessage("Error submitting medication. Please try again.")});const submitMedicationButtons=document.querySelectorAll(".submit-medication-button");submitMedicationButtons.forEach(button=>{button.click()});const medicationContainer=document.getElementById("medicationInputsContainer");medicationContainer.innerHTML="";document.getElementById("resultsObtained").value="";document.getElementById("additionalNotes").value=""});const onlineStatusElement=document.getElementById("onlineStatus");const overlayElement=document.getElementById("overlay");function updateOnlineStatus(){if(navigator.onLine){onlineStatusElement.innerHTML='<i class="fa fa-wifi"></i>';onlineStatusElement.classList.remove("offline");onlineStatusElement.classList.add("online");overlayElement.style.display="none"}else{onlineStatusElement.innerHTML='<i class="fa fa-exclamation-triangle"></i>';onlineStatusElement.classList.remove("online");onlineStatusElement.classList.add("offline");overlayElement.style.display="block"}}updateOnlineStatus();window.addEventListener("online",updateOnlineStatus);window.addEventListener("offline",updateOnlineStatus);window.addEventListener("load",function(){const splashScreen=document.getElementById("splashScreen");splashScreen.style.opacity="0";setTimeout(function(){splashScreen.style.display="none"},500)});const messagesRef=ref(database,"chat-messages");const chatBox=document.getElementById("chatBox");const messageInput=document.getElementById("messageInput");const sendMessageBtn=document.getElementById("sendMessageBtn");const messageSentAudio=new Audio("COMCell_Message sent (ID 1313)_BSB.mp3");const newMessageAudio=new Audio("livechat-129007.mp3");let displayedMessageIds=[];onValue(messagesRef,snapshot=>{if(snapshot.exists()){snapshot.forEach(childSnapshot=>{const messageId=childSnapshot.key;const message=childSnapshot.val();if(!displayedMessageIds.includes(messageId)){displayChatMessage(message);playMessageSound(message.sender);displayedMessageIds.push(messageId)}})}});function displayChatMessage(message){if(message){const messageDiv=document.createElement("div");const headerDiv=document.createElement("div");headerDiv.classList.add("message-header");const profileIcon=document.createElement("img");profileIcon.src="profile.webp";profileIcon.classList.add("profile-icon2");headerDiv.appendChild(profileIcon);const nameSpan=document.createElement("span");nameSpan.textContent=message.sender;nameSpan.style.fontWeight="bold";headerDiv.appendChild(nameSpan);messageDiv.appendChild(headerDiv);const messageTextSpan=document.createElement("span");messageTextSpan.textContent=message.text;messageDiv.appendChild(messageTextSpan);const timestampSpan=document.createElement("span");const timestamp=new Date(message.timestamp);const formattedDate=`${timestamp.toLocaleDateString()} `;const formattedTime=`${timestamp.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}`;timestampSpan.textContent=`${formattedDate}${formattedTime}`;timestampSpan.style.fontSize="9px";timestampSpan.style.color="#888";messageDiv.appendChild(timestampSpan);if(message.sender==="Laboratory"){messageDiv.classList.add("patients-reception")}else{messageDiv.classList.add("other-sender")}chatBox.appendChild(messageDiv);chatBox.scrollTop=chatBox.scrollHeight}}function playMessageSound(sender){if(sender==="Laboratory"){messageSentAudio.play()}else{newMessageAudio.play()}}sendMessageBtn.addEventListener("click",()=>{const messageText=messageInput.value.trim();if(messageText!==""){const sender="Laboratory";const timestamp=(new Date).toISOString();const message={text:messageText,sender:sender,timestamp:timestamp};push(messagesRef,message).catch(error=>{console.error("Error sending message:",error)});messageInput.value=""}});